<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Kill Team Planner</title>
<style>
body { margin:0; font-family:sans-serif; }

#toolbar {
  height:50px; background:#222; display:flex; align-items:center; padding:5px; gap:5px;
}
#toolbar button, #toolbar select { padding:5px 10px; font-size:14px; cursor:pointer; }

#board {
  width:100vw; height:calc(100vh - 50px); position:relative; overflow:hidden; touch-action:none;
  background: url('mapa.jpg') no-repeat center center; background-size:cover; z-index:1;
}

/* Cuadrícula encima del mapa */
#board::after {
  content:""; position:absolute; top:0; left:0; width:100%; height:100%;
  pointer-events:none; z-index:2;
  background-image:
    linear-gradient(to right, rgba(255,255,255,0.15) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255,255,255,0.15) 1px, transparent 1px);
  background-size:28px 28px; /* 1 celda = 1 pulgada = 28px */
}

/* Fichas, objetivos y flechas */
.token, .objective, .line { position:absolute; z-index:10; }
.token { border-radius:50%; cursor:grab; }
.objective {
  width:24px; height:24px; border-radius:50%; background:orange; color:black;
  text-align:center; font-weight:bold; line-height:24px; cursor:grab; user-select:none;
}
.line { width:2px; background:red; }
</style>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<div id="toolbar">
  <select id="unitType">
    <option value="small">Peana 25mm</option>
    <option value="normal" selected>Peana 28mm</option>
    <option value="large">Peana 32mm</option>
    <option value="huge">Peana 40mm</option>
  </select>
  <button id="blueBtn">Ficha azul</button>
  <button id="redBtn">Ficha roja</button>
  <button id="moveBtn">Mover</button>
  <button id="drawBtn">Flecha</button>
  <button id="eraseBtn">Borrar</button>
  <button id="objectiveBtn">Objetivo</button>
  <button id="exportBtn">Exportar</button>
</div>

<div id="board"></div>

<script>
window.onload = () => {
  const board = document.getElementById('board');
  let mode = 'move';

  // Tamaños de peanas en mm
  const sizesMM = { small:25, normal:28, large:32, huge:40 };
  // Conversión mm -> px, 1 pulgada = 28px
  const mmToPx = mm => mm * (28 / 25.4);

  const unitSelect = document.getElementById('unitType');

  // Botones
  document.getElementById('blueBtn').onclick = () => addToken('blue');
  document.getElementById('redBtn').onclick = () => addToken('red');
  document.getElementById('moveBtn').onclick = () => mode='move';
  document.getElementById('drawBtn').onclick = () => mode='draw';
  document.getElementById('eraseBtn').onclick = () => mode='erase';
  document.getElementById('objectiveBtn').onclick = () => mode='objective';
  document.getElementById('exportBtn').onclick = () => {
    html2canvas(board).then(canvas=>{
      const link = document.createElement('a');
      link.download='kt-plan.png';
      link.href=canvas.toDataURL();
      link.click();
    });
  };

  // Crear ficha
  function addToken(color){
    const type = unitSelect.value; // obtiene el valor del select
    if(!sizesMM[type]) return;
    const sizePx = mmToPx(sizesMM[type]);
    const token = document.createElement('div');
    token.className = 'token '+color;
    token.style.width = sizePx+'px';
    token.style.height = sizePx+'px';
    token.style.left='50px';
    token.style.top='50px';
    makeDraggable(token);
    board.appendChild(token);
  }

  // Movible
  function makeDraggable(el){
    el.onmousedown = e=>{
      e.preventDefault();
      let offsetX = e.clientX - el.offsetLeft;
      let offsetY = e.clientY - el.offsetTop;
      function mouseMoveHandler(e){
        el.style.left = (e.clientX - offsetX)+'px';
        el.style.top = (e.clientY - offsetY)+'px';
      }
      function mouseUpHandler(){
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
      }
      document.addEventListener('mousemove', mouseMoveHandler);
      document.addEventListener('mouseup', mouseUpHandler);
    };
  }

  // Dibujar flechas
  let startX, startY, tempLine;
  board.onmousedown = e=>{
    if(mode==='draw'){
      startX=e.offsetX; startY=e.offsetY;
      tempLine=document.createElement('div');
      tempLine.className='line';
      tempLine.style.left=startX+'px';
      tempLine.style.top=startY+'px';
      tempLine.style.width='0px';
      tempLine.style.height='2px';
      board.appendChild(tempLine);
      board.onmousemove=drawMove;
      board.onmouseup=drawEnd;
    }
  };
  function drawMove(e){
    const width=Math.hypot(e.offsetX-startX,e.offsetY-startY);
    tempLine.style.width=width+'px';
    const angle=Math.atan2(e.offsetY-startY,e.offsetX-startX)*180/Math.PI;
    tempLine.style.transform=`rotate(${angle}deg)`;
    tempLine.style.transformOrigin='0 0';
  }
  function drawEnd(e){
    board.onmousemove=null;
    board.onmouseup=null;
    tempLine=null;
    mode='move';
  }

  // Click tablero: objetivos o borrar
  board.onclick = e=>{
    if(mode==='objective'){
      const objective=document.createElement('div');
      objective.className='objective';
      objective.style.left=(e.offsetX-12)+'px';
      objective.style.top=(e.offsetY-12)+'px';
      objective.innerText=prompt("Número o letra del objetivo:","1")||"1";
      makeDraggable(objective);
      board.appendChild(objective);
      mode='move';
    }
    if(mode==='erase'){
      const el=e.target;
      if(el.classList.contains('token') || el.classList.contains('objective') || el.classList.contains('line')){
        el.remove();
      }
      mode='move';
    }
  };
};
</script>

</body>
</html>
