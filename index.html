<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Kill Team Planner</title>

<style>
  body {
    margin: 0;
    font-family: sans-serif;
  }

  #toolbar {
    height: 50px;
    background: #222;
    display: flex;
    align-items: center;
    padding: 5px;
    gap: 5px;
  }

  #toolbar button, #toolbar select {
    padding: 5px 10px;
    font-size: 14px;
    cursor: pointer;
  }

  #board {
    width: 100vw;
    height: calc(100vh - 50px);
    position: relative;
    overflow: hidden;
    touch-action: none;

    /* Mapa de fondo */
    background: url('mapa.jpg') no-repeat center center;
    background-size: cover;
  }

  /* Cuadrícula encima */
  #board::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;

    background-image:
      linear-gradient(to right, rgba(255,255,255,0.15) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,0.15) 1px, transparent 1px);
    background-size: 28px 28px; /* Ajusta según escala deseada */
  }

  .token, .objective, .line {
    position: absolute;
  }

  .token {
    border-radius: 50%;
    cursor: grab;
  }

  .objective {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: orange;
    color: black;
    text-align: center;
    font-weight: bold;
    line-height: 24px;
    cursor: grab;
    user-select: none;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>

<div id="toolbar">
  <select id="unitType">
    <option value="small">Peana 25mm</option>
    <option value="normal" selected>Peana 28mm</option>
    <option value="large">Peana 32mm</option>
    <option value="huge">Peana 40mm</option>
  </select>

  <button id="blueBtn">Ficha azul</button>
  <button id="redBtn">Ficha roja</button>
  <button id="moveBtn">Mover</button>
  <button id="drawBtn">Flecha</button>
  <button id="eraseBtn">Borrar</button>
  <button id="objectiveBtn">Objetivo</button>
  <button id="exportBtn">Exportar</button>
</div>

<div id="board"></div>

<script>
window.onload = () => {
  const board = document.getElementById('board');
  let mode = 'move';

  // Tamaños de peanas
  const sizes = { small: 25, normal: 28, large: 32, huge: 40 };

  // Botones
  document.getElementById('blueBtn').onclick = () => addToken('blue');
  document.getElementById('redBtn').onclick = () => addToken('red');
  document.getElementById('moveBtn').onclick = () => mode = 'move';
  document.getElementById('drawBtn').onclick = () => mode = 'draw';
  document.getElementById('eraseBtn').onclick = () => mode = 'erase';
  document.getElementById('objectiveBtn').onclick = () => mode = 'objective';
  document.getElementById('exportBtn').onclick = () => {
    html2canvas(board).then(canvas => {
      const link = document.createElement('a');
      link.download = 'kt-plan.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  };

  // Función para crear ficha según selector
  function addToken(color) {
    const type = document.getElementById('unitType').value;
    const token = document.createElement('div');
    token.className = 'token ' + color;
    token.style.width = sizes[type] + 'px';
    token.style.height = sizes[type] + 'px';
    token.style.left = '50px';
    token.style.top = '50px';
    makeDraggable(token);
    board.appendChild(token);
  }

  // Función para mover elementos
  function makeDraggable(el) {
    el.onmousedown = e => {
      e.preventDefault();
      let offsetX = e.clientX - el.offsetLeft;
      let offsetY = e.clientY - el.offsetTop;

      function mouseMoveHandler(e) {
        el.style.left = (e.clientX - offsetX) + 'px';
        el.style.top = (e.clientY - offsetY) + 'px';
      }

      function mouseUpHandler() {
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
      }

      document.addEventListener('mousemove', mouseMoveHandler);
      document.addEventListener('mouseup', mouseUpHandler);
    };
  }

  // Eventos del tablero solo para objetivos, flechas y borrar
  board.onclick = e => {
    if (mode === 'objective') {
      const objective = document.createElement('div');
      objective.className = 'objective';
      objective.style.left = (e.offsetX - 12) + 'px';
      objective.style.top = (e.offsetY - 12) + 'px';
      objective.innerText = prompt("Número o letra del objetivo:", "1") || "1";
      makeDraggable(objective);
      board.appendChild(objective);
      mode = 'move';
    }

    // Aquí puedes añadir lógica de flechas y borrar
    if (mode === 'erase') {
      const el = e.target;
      if (el.classList.contains('token') || el.classList.contains('objective') || el.classList.contains('line')) {
        el.remove();
      }
      mode = 'move';
    }
  };
};

</script>

</body>
</html>
